#!/bin/sh

export PATH="$HOME/.local/share/mise/shims:$PATH"

. /Users/Oli/.env

# Generate the budget report
/opt/homebrew/bin/hledger -f $FINANCES/actuals.journal -f $FINANCES/forecast.journal bal -M --tree --budget expenses -b "1 month ago " -e "2 months" -O html >$FINANCES/budget.html
cp $FINANCES/budget.html /Users/Oli/Documents/Finances/budget.html
rm $FINANCES/budget.html

# Generate the forecast report
/opt/homebrew/bin/hledger -f $FINANCES/actuals.journal -f $FINANCES/forecast.journal --auto --forecast="this month".. bal "^(ass|liab)" --tree -H -M -b "1 month ago" -e "36 months" -O html >$FINANCES/generated.html

inputFile=$FINANCES/generated.html
outputFile=$FINANCES/output.html

# Start of the HTML document
echo '<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hledger Output</title>
      <style>
          body{margin:0;padding:10px;font-family:Arial,sans-serif;background-color:#f5f7fa}
          .table-container{overflow-x:auto;-webkit-overflow-scrolling:touch;border:1px solid #cbd5e0;border-radius:8px;background-color:#fff}
          table{width:100%;border-collapse:collapse;font-family:Arial,sans-serif}
          th,td{padding:8px 12px;text-align:left;border-bottom:1px solid #e2e8f0;white-space:nowrap}
          th{background-color:#4299e1;color:#fff;font-weight:600}
          td.amount{text-align:right;color:#2d3748}
          tr:nth-child(even){background-color:#f7fafc}
          tr:hover{background-color:#edf2f7}
          .account{font-weight:600;color:#2c5282}
          .coltotal{background-color:#bee3f8;color:#2c5282}
          td,th{text-align:right}
          td.account,th.account{text-align:left;position:sticky;left:0;background-color:#fff;z-index:2;box-shadow:2px 0 5px rgba(0,0,0,.08);padding-left:16px;padding-right:16px;min-width:140px}
          th.account{background-color:#4299e1;color:#fff;font-weight:600;z-index:3}
          tr:nth-child(even) td.account{background-color:#f7fafc}
          tr:hover td.account{background-color:#edf2f7}
          tr:last-child td{background-color:#bee3f8;font-weight:600;color:#2c5282}
          tr:last-child td.account{background-color:#bee3f8}
      </style>
</head>
<body>' >$outputFile

# Append the table data with wrapper
echo '<div class="table-container">' >>$outputFile
cat $inputFile >>$outputFile
echo '</div>' >>$outputFile

# End of the HTML document
echo '</body>
</html>' >>$outputFile

cp $outputFile /Users/Oli/Documents/Finances/forecast.html
rm $inputFile
rm $outputFile
